# Define the rate limit zone (10 MB shared memory for tracking client states)
limit_req_zone $binary_remote_addr zone=perip:10m rate=1r/s;

# Upstream backend 
upstream httpbin {
    zone httpbin 64k;
    server 10.1.20.22:30080;  # K8s node and NodePort
}

server {
    listen 8000;

    status_zone httpbin_zone;   # For NGINX Plus live activity monitoring
    access_log /var/log/nginx/httpbin_access.log;
    error_log  /var/log/nginx/httpbin_error.log;

    location / {
        proxy_pass http://httpbin;

        # Apply the rate limit (burst allows 1 queued request)
        limit_req zone=perip burst=1 nodelay;

        # Optional: set headers to identify client & proxy
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
